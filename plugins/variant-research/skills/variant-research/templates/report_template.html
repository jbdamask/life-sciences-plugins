<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Variant Research Report: {{ rsid }} ({{ gene_symbol }})</title>
<style>
  :root {
    --primary: #1a365d;
    --primary-light: #2b6cb0;
    --accent: #e53e3e;
    --bg: #f7fafc;
    --card-bg: #ffffff;
    --border: #e2e8f0;
    --text: #2d3748;
    --text-light: #718096;
    --success: #38a169;
    --warning: #dd6b20;
    --info: #3182ce;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
  }
  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    padding: 30px;
    border-radius: 8px;
    margin-bottom: 24px;
  }
  header h1 { font-size: 1.8rem; margin-bottom: 4px; }
  header .subtitle { opacity: 0.9; font-size: 1.1rem; }
  header .meta { opacity: 0.7; font-size: 0.85rem; margin-top: 8px; }
  .section {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  .section summary {
    padding: 16px 20px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 10px;
    user-select: none;
    list-style: none;
  }
  .section summary::-webkit-details-marker { display: none; }
  .section summary::before {
    content: "\25B6";
    font-size: 0.7rem;
    transition: transform 0.2s;
    color: var(--text-light);
  }
  .section[open] summary::before { transform: rotate(90deg); }
  .section-content { padding: 0 20px 20px; }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .badge-pathogenic { background: #fed7d7; color: #c53030; }
  .badge-benign { background: #c6f6d5; color: #276749; }
  .badge-vus { background: #fefcbf; color: #975a16; }
  .badge-approved { background: #c6f6d5; color: #276749; }
  .badge-phase3 { background: #bee3f8; color: #2a4365; }
  .badge-phase2 { background: #e9d8fd; color: #553c9a; }
  .badge-phase1 { background: #fefcbf; color: #975a16; }
  .badge-recruiting { background: #bee3f8; color: #2a4365; }
  .badge-completed { background: #c6f6d5; color: #276749; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 12px 0;
    font-size: 0.9rem;
  }
  th, td {
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }
  th {
    background: #edf2f7;
    font-weight: 600;
    position: sticky;
    top: 0;
    cursor: pointer;
  }
  th:hover { background: #e2e8f0; }
  tr:hover td { background: #f7fafc; }
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
    margin: 12px 0;
  }
  .info-item {
    padding: 12px;
    background: #f7fafc;
    border-radius: 6px;
    border-left: 3px solid var(--primary-light);
  }
  .info-item .label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--text-light);
    font-weight: 600;
    margin-bottom: 2px;
  }
  .info-item .value { font-size: 1rem; font-weight: 500; }
  .unavailable {
    padding: 20px;
    background: #fff5f5;
    border: 1px solid #fed7d7;
    border-radius: 6px;
    color: #c53030;
    text-align: center;
  }
  .error-list { color: var(--accent); font-size: 0.85rem; margin-top: 8px; }
  a { color: var(--info); text-decoration: none; }
  a:hover { text-decoration: underline; }
  .company-card {
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px;
    margin: 8px 0;
  }
  .company-card h4 { color: var(--primary); margin-bottom: 8px; }
  .count-badge {
    display: inline-block;
    background: var(--primary-light);
    color: white;
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    margin-left: 6px;
  }
  .score-bar {
    display: inline-block;
    height: 8px;
    background: var(--primary-light);
    border-radius: 4px;
    min-width: 4px;
  }
  .toc { margin: 16px 0; }
  .toc a {
    display: inline-block;
    margin: 4px 8px 4px 0;
    padding: 4px 12px;
    background: #edf2f7;
    border-radius: 16px;
    font-size: 0.85rem;
  }
  .toc a:hover { background: #e2e8f0; text-decoration: none; }
  @media (max-width: 768px) {
    .container { padding: 10px; }
    header { padding: 20px; }
    header h1 { font-size: 1.4rem; }
    .info-grid { grid-template-columns: 1fr; }
    table { font-size: 0.8rem; }
    th, td { padding: 6px 8px; }
  }
  @media print {
    .section { break-inside: avoid; }
    header { background: var(--primary) !important; -webkit-print-color-adjust: exact; }
  }
</style>
</head>
<body>
<div class="container">

<header>
  <h1>{{ rsid | upper }} — {{ gene_symbol }}</h1>
  <div class="subtitle">{{ gene_name if gene_name else "Genomic Variant Research Report" }}</div>
  <div class="meta">Generated {{ generated_at }}</div>
</header>

<nav class="toc">
  <a href="#variant-summary">Variant Summary</a>
  <a href="#clinical-significance">Clinical</a>
  <a href="#gwas">GWAS</a>
  <a href="#literature">Literature</a>
  <a href="#patents">Patents</a>
  <a href="#protein">Protein</a>
  <a href="#drug-targets">Drug Targets</a>
  <a href="#competitive-intel">Competitive Intel</a>
  <a href="#references">References</a>
</nav>

<!-- 1. VARIANT SUMMARY -->
<details class="section" open id="variant-summary">
<summary>Variant Summary</summary>
<div class="section-content">
{% if variant_info.get("_unavailable") %}
  <div class="unavailable">Variant resolution data unavailable.</div>
{% else %}
  <div class="info-grid">
    <div class="info-item">
      <div class="label">rsID</div>
      <div class="value">{{ variant_info.get("rsid", "—") | upper }}</div>
    </div>
    <div class="info-item">
      <div class="label">Gene Symbol</div>
      <div class="value">{{ variant_info.get("gene_symbol", "—") }}</div>
    </div>
    <div class="info-item">
      <div class="label">Gene Name</div>
      <div class="value">{{ variant_info.get("gene_name", "—") or "—" }}</div>
    </div>
    <div class="info-item">
      <div class="label">Ensembl Gene ID</div>
      <div class="value">{{ variant_info.get("ensembl_gene_id", "—") or "—" }}</div>
    </div>
    <div class="info-item">
      <div class="label">Location</div>
      <div class="value">chr{{ variant_info.get("chromosome", "?") }}:{{ variant_info.get("position", "?") }}</div>
    </div>
    <div class="info-item">
      <div class="label">Alleles</div>
      <div class="value">{{ variant_info.get("alleles", "—") or "—" }}</div>
    </div>
    <div class="info-item">
      <div class="label">Consequence</div>
      <div class="value">{{ variant_info.get("consequence", "—") or "—" }}</div>
    </div>
    <div class="info-item">
      <div class="label">Protein Change</div>
      <div class="value">{{ variant_info.get("protein_change", "—") or "—" }}</div>
    </div>
    <div class="info-item">
      <div class="label">ClinVar Significance</div>
      <div class="value">
        {% set sig = variant_info.get("clinvar_significance", "") %}
        {% if sig %}
          {% if "pathogenic" in sig|lower %}<span class="badge badge-pathogenic">{{ sig }}</span>
          {% elif "benign" in sig|lower %}<span class="badge badge-benign">{{ sig }}</span>
          {% else %}<span class="badge badge-vus">{{ sig }}</span>{% endif %}
        {% else %}—{% endif %}
      </div>
    </div>
  </div>
  {% if variant_info.get("errors") %}
    <div class="error-list">Warnings: {{ variant_info["errors"] | join(", ") }}</div>
  {% endif %}
{% endif %}
</div>
</details>

<!-- 2. CLINICAL SIGNIFICANCE -->
<details class="section" id="clinical-significance">
<summary>Clinical Significance</summary>
<div class="section-content">
{% if clinical.get("_unavailable") %}
  <div class="unavailable">Clinical data unavailable.</div>
{% else %}
  {% set clinvar = clinical.get("clinvar_entries", []) %}
  {% if clinvar %}
    <h3>ClinVar Entries</h3>
    <table>
      <thead><tr><th>Variant</th><th>Significance</th><th>Condition</th><th>Review Status</th><th>Last Evaluated</th></tr></thead>
      <tbody>
      {% for entry in clinvar %}
        <tr>
          {% set vcv = entry.get("variant_id", "") %}
          <td><a href="https://www.ncbi.nlm.nih.gov/clinvar/variation/{{ vcv.replace('VCV', '').lstrip('0') or vcv }}/" target="_blank" rel="noopener">{{ entry.get("title", vcv) or vcv }}</a></td>
          <td>
            {% set s = entry.get("clinical_significance", "") %}
            {% if "pathogenic" in s|lower %}<span class="badge badge-pathogenic">{{ s }}</span>
            {% elif "benign" in s|lower %}<span class="badge badge-benign">{{ s }}</span>
            {% elif "protective" in s|lower %}<span class="badge badge-benign">{{ s }}</span>
            {% else %}<span class="badge badge-vus">{{ s }}</span>{% endif %}
          </td>
          <td>{{ entry.get("conditions", "—") or "—" }}</td>
          <td>{{ entry.get("review_status", "—") }}</td>
          <td>{{ entry.get("last_evaluated", "—") }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No ClinVar entries found for this variant.</p>
  {% endif %}

  {% set trials = clinical.get("clinical_trials", []) %}
  {% if trials %}
    <h3 style="margin-top:16px;">Clinical Trials</h3>
    <table>
      <thead><tr><th>NCT ID</th><th>Title</th><th>Phase</th><th>Status</th><th>Sponsor</th></tr></thead>
      <tbody>
      {% for trial in trials %}
        <tr>
          <td><a href="https://clinicaltrials.gov/study/{{ trial.get('nct_id', '') }}" target="_blank">{{ trial.get("nct_id", "—") }}</a></td>
          <td>{{ trial.get("title", "—") }}</td>
          <td>{{ trial.get("phase", "—") }}</td>
          <td>
            {% set st = trial.get("status", "") %}
            {% if "recruiting" in st|lower %}<span class="badge badge-recruiting">{{ st }}</span>
            {% elif "completed" in st|lower %}<span class="badge badge-completed">{{ st }}</span>
            {% else %}{{ st }}{% endif %}
          </td>
          <td>{{ trial.get("sponsor", "—") }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% if clinical.get("errors") %}
    <div class="error-list">Errors: {{ clinical["errors"] | join(", ") }}</div>
  {% endif %}
{% endif %}
</div>
</details>

<!-- 3. GWAS ASSOCIATIONS -->
<details class="section" id="gwas">
<summary>GWAS Associations</summary>
<div class="section-content">
{% if clinical.get("_unavailable") %}
  <div class="unavailable">GWAS data unavailable.</div>
{% else %}
  {% set gwas = clinical.get("gwas_associations", []) %}
  {% if gwas %}
    <table>
      <thead><tr><th>Trait / Disease</th><th>P-value</th><th>Effect Size</th><th>Risk Allele</th><th>Study</th></tr></thead>
      <tbody>
      {% for assoc in gwas %}
        <tr>
          <td>{{ assoc.get("trait", "—") }}</td>
          <td>{{ assoc.get("p_value", "—") }}</td>
          <td>{{ assoc.get("effect_size", "—") }}</td>
          <td>{{ assoc.get("risk_allele", "—") }}</td>
          <td>
            {% if assoc.get("pmid") %}
              <a href="https://pubmed.ncbi.nlm.nih.gov/{{ assoc['pmid'] }}/" target="_blank">PMID:{{ assoc["pmid"] }}</a>
            {% else %}—{% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No GWAS associations found for this variant.</p>
  {% endif %}
{% endif %}
</div>
</details>

<!-- 4. LITERATURE REVIEW -->
<details class="section" id="literature">
<summary>Literature Review</summary>
<div class="section-content">
{% if literature.get("_unavailable") %}
  <div class="unavailable">Literature data unavailable.</div>
{% else %}
  {% set pubmed = literature.get("pubmed_articles", []) %}
  {% if pubmed %}
    <h3>PubMed Articles <span class="count-badge">{{ pubmed | length }}</span></h3>
    <table>
      <thead><tr><th>Year</th><th>Title</th><th>Authors</th><th>Journal</th><th>PMID</th></tr></thead>
      <tbody>
      {% for article in pubmed %}
        <tr>
          <td>{{ article.get("year", "—") }}</td>
          <td>{{ article.get("title", "—") }}</td>
          <td>{{ article.get("authors", "—") }}</td>
          <td>{{ article.get("journal", "—") }}</td>
          <td><a href="https://pubmed.ncbi.nlm.nih.gov/{{ article.get('pmid', '') }}/" target="_blank">{{ article.get("pmid", "—") }}</a></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% set scholar = literature.get("scholar_articles", []) %}
  {% if scholar %}
    <h3 style="margin-top:16px;">Google Scholar <span class="count-badge">{{ scholar | length }}</span></h3>
    <table>
      <thead><tr><th>Year</th><th>Title</th><th>Authors</th></tr></thead>
      <tbody>
      {% for article in scholar %}
        <tr>
          <td>{{ article.get("year", "—") }}</td>
          <td>{% if article.get("url") %}<a href="{{ article['url'] }}" target="_blank">{{ article.get("title", "—") }}</a>{% else %}{{ article.get("title", "—") }}{% endif %}</td>
          <td>{{ article.get("authors", "—") }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% if not pubmed and not scholar %}
    <p>No literature found.</p>
  {% endif %}

  {% if literature.get("errors") %}
    <div class="error-list">Errors: {{ literature["errors"] | join(", ") }}</div>
  {% endif %}
{% endif %}
</div>
</details>

<!-- 5. PATENT LANDSCAPE -->
<details class="section" id="patents">
<summary>Patent Landscape</summary>
<div class="section-content">
{% if patents.get("_unavailable") %}
  <div class="unavailable">Patent data unavailable.</div>
{% else %}
  {% set pat_list = patents.get("patents", []) %}
  {% if pat_list %}
    <table>
      <thead><tr><th>Date</th><th>Patent #</th><th>Title</th><th>Assignee</th><th>Type</th></tr></thead>
      <tbody>
      {% for patent in pat_list %}
        <tr>
          <td>{{ patent.get("date", "—") }}</td>
          <td><a href="https://patents.google.com/patent/US{{ patent.get('patent_number', '') }}" target="_blank" rel="noopener">{{ patent.get("patent_number", "—") }}</a></td>
          <td>{{ patent.get("title", "—") }}</td>
          <td>{{ patent.get("assignee", "—") }}</td>
          <td>{{ patent.get("classification", "—") }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No patents found.</p>
  {% endif %}

  {% if patents.get("errors") %}
    <div class="error-list">Errors: {{ patents["errors"] | join(", ") }}</div>
  {% endif %}
{% endif %}
</div>
</details>

<!-- 6. PROTEIN INTERACTIONS -->
<details class="section" id="protein">
<summary>Protein Interactions &amp; Expression</summary>
<div class="section-content">
{% if protein.get("_unavailable") %}
  <div class="unavailable">Protein interaction data unavailable.</div>
{% else %}

  {# STRING-db #}
  {% set string_data = protein.get("string_interactions", {}) %}
  {% set string_list = string_data.get("interactions", string_data.get("partners", [])) %}
  {% if string_list %}
    <h3>STRING-db Interactions <span class="count-badge">{{ string_list | length }}</span></h3>
    <table>
      <thead><tr><th>Partner</th><th>Score</th><th>Sources</th></tr></thead>
      <tbody>
      {% for item in string_list[:20] %}
        <tr>
          <td>{{ item.get("partner", item.get("preferredName", "—")) }}</td>
          <td>
            {{ item.get("score", item.get("combined_score", "—")) }}
            {% set sc = item.get("score", item.get("combined_score", 0)) %}
            {% if sc %}<div class="score-bar" style="width:{{ (sc|float * 100) if sc|float <= 1 else (sc|float / 10) }}px"></div>{% endif %}
          </td>
          <td>{{ item.get("sources", "—") }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {# HPA #}
  {% set hpa = protein.get("hpa_expression", {}) %}
  {% if hpa and not hpa.get("_unavailable") %}
    <h3 style="margin-top:16px;">Human Protein Atlas</h3>
    <div class="info-grid">
      {% if hpa.get("protein_class") %}
      <div class="info-item">
        <div class="label">Protein Class</div>
        <div class="value">{{ hpa["protein_class"] }}</div>
      </div>
      {% endif %}
      {% if hpa.get("subcellular_location") %}
      <div class="info-item">
        <div class="label">Subcellular Location</div>
        <div class="value">{{ hpa["subcellular_location"] }}</div>
      </div>
      {% endif %}
      {% if hpa.get("tissue_expression") %}
      <div class="info-item">
        <div class="label">Top Tissues</div>
        <div class="value">{{ hpa["tissue_expression"] }}</div>
      </div>
      {% endif %}
      {% if hpa.get("rna_expression") %}
      <div class="info-item">
        <div class="label">RNA Expression</div>
        <div class="value">{{ hpa["rna_expression"] }}</div>
      </div>
      {% endif %}
    </div>
  {% endif %}

  {# IntAct #}
  {% set intact = protein.get("intact", {}) %}
  {% set intact_list = intact.get("interactions", []) %}
  {% if intact_list %}
    <h3 style="margin-top:16px;">IntAct Interactions <span class="count-badge">{{ intact.get("total_count", intact_list | length) }}</span></h3>
    <table>
      <thead><tr><th>Interactors</th><th>Type</th><th>Method</th><th>PubMed</th><th>Score</th></tr></thead>
      <tbody>
      {% for item in intact_list[:15] %}
        <tr>
          <td>{{ item.get("interactors", []) | join(", ") }}</td>
          <td>{{ item.get("interaction_type", "—") }}</td>
          <td>{{ item.get("detection_method", "—") }}</td>
          <td>{% if item.get("publication") %}<a href="https://pubmed.ncbi.nlm.nih.gov/{{ item['publication'] }}/" target="_blank">{{ item["publication"] }}</a>{% else %}—{% endif %}</td>
          <td>{{ item.get("confidence_score", "—") }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {# BioPlex #}
  {% set bioplex = protein.get("bioplex", {}) %}
  {% set bioplex_list = bioplex.get("interactions", []) %}
  {% if bioplex_list %}
    <h3 style="margin-top:16px;">BioPlex Interactions <span class="count-badge">{{ bioplex.get("total_count", bioplex_list | length) }}</span></h3>
    <table>
      <thead><tr><th>Gene A</th><th>Gene B</th><th>P(Interaction)</th><th>P(Wrong)</th></tr></thead>
      <tbody>
      {% for item in bioplex_list[:15] %}
        <tr>
          <td>{{ item.get("symbol_a", item.get("gene_a", "—")) }}</td>
          <td>{{ item.get("symbol_b", item.get("gene_b", "—")) }}</td>
          <td>{{ item.get("p_interaction", "—") }}</td>
          <td>{{ item.get("p_wrong", "—") }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {# BioGRID #}
  {% set biogrid = protein.get("biogrid", {}) %}
  {% set biogrid_list = biogrid.get("interactions", []) %}
  {% if biogrid_list %}
    <h3 style="margin-top:16px;">BioGRID Interactions <span class="count-badge">{{ biogrid.get("total_count", biogrid_list | length) }}</span></h3>
    <table>
      <thead><tr><th>Gene A</th><th>Gene B</th><th>System</th><th>Throughput</th><th>PubMed</th></tr></thead>
      <tbody>
      {% for item in biogrid_list[:15] %}
        <tr>
          <td>{{ item.get("gene_a", "—") }}</td>
          <td>{{ item.get("gene_b", "—") }}</td>
          <td>{{ item.get("experimental_system", "—") }}</td>
          <td>{{ item.get("throughput", "—") }}</td>
          <td>{% if item.get("pubmed_id") %}<a href="https://pubmed.ncbi.nlm.nih.gov/{{ item['pubmed_id'] }}/" target="_blank">{{ item["pubmed_id"] }}</a>{% else %}—{% endif %}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% if protein.get("errors") %}
    <div class="error-list">Errors: {{ protein["errors"] | join(", ") }}</div>
  {% endif %}
{% endif %}
</div>
</details>

<!-- 7. DRUG TARGET ANALYSIS -->
<details class="section" id="drug-targets">
<summary>Drug Target Analysis</summary>
<div class="section-content">
{% if drug_targets.get("_unavailable") %}
  <div class="unavailable">Drug target data unavailable.</div>
{% else %}

  {# Target info #}
  {% set target = drug_targets.get("target_info", {}) %}
  {% if target %}
    <div class="info-grid">
      {% if target.get("description") %}
      <div class="info-item" style="grid-column: span 2;">
        <div class="label">Description</div>
        <div class="value">{{ target["description"] }}</div>
      </div>
      {% endif %}
      {% if target.get("protein_class") %}
      <div class="info-item">
        <div class="label">Protein Class</div>
        <div class="value">{{ target["protein_class"] }}</div>
      </div>
      {% endif %}
    </div>
  {% endif %}

  {# Tractability #}
  {% set tract = drug_targets.get("tractability", {}) %}
  {% if tract %}
    <h3 style="margin-top:16px;">Tractability Assessment</h3>
    <div class="info-grid">
      {% if tract.get("small_molecule") is not none %}
      <div class="info-item">
        <div class="label">Small Molecule</div>
        <div class="value">{{ tract["small_molecule"] }}</div>
      </div>
      {% endif %}
      {% if tract.get("antibody") is not none %}
      <div class="info-item">
        <div class="label">Antibody</div>
        <div class="value">{{ tract["antibody"] }}</div>
      </div>
      {% endif %}
      {% if tract.get("other_modalities") is not none %}
      <div class="info-item">
        <div class="label">Other Modalities</div>
        <div class="value">{{ tract["other_modalities"] }}</div>
      </div>
      {% endif %}
    </div>
  {% endif %}

  {# Known drugs #}
  {% set drugs = drug_targets.get("known_drugs", []) %}
  {% if drugs %}
    <h3 style="margin-top:16px;">Known Drugs <span class="count-badge">{{ drugs | length }}</span></h3>
    <table>
      <thead><tr><th>Drug</th><th>Type</th><th>Mechanism</th><th>Phase</th><th>Indication</th><th>Company</th></tr></thead>
      <tbody>
      {% for drug in drugs %}
        <tr>
          <td><strong>{{ drug.get("drug_name", "—") }}</strong></td>
          <td>{{ drug.get("drug_type", "—") }}</td>
          <td>{{ drug.get("mechanism_of_action", "—") }}</td>
          <td>
            {% set ph = drug.get("phase", "") | string | lower %}
            {% if "approved" in ph %}<span class="badge badge-approved">{{ drug.get("phase", "") }}</span>
            {% elif "3" in ph %}<span class="badge badge-phase3">{{ drug.get("phase", "") }}</span>
            {% elif "2" in ph %}<span class="badge badge-phase2">{{ drug.get("phase", "") }}</span>
            {% elif "1" in ph %}<span class="badge badge-phase1">{{ drug.get("phase", "") }}</span>
            {% else %}{{ drug.get("phase", "—") }}{% endif %}
          </td>
          <td>{{ drug.get("indication", "—") }}</td>
          <td>{{ drug.get("company", "—") }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {# Disease associations #}
  {% set diseases = drug_targets.get("disease_associations", []) %}
  {% if diseases %}
    <h3 style="margin-top:16px;">Disease Associations <span class="count-badge">{{ diseases | length }}</span></h3>
    <table>
      <thead><tr><th>Disease</th><th>Score</th><th>Evidence</th></tr></thead>
      <tbody>
      {% for disease in diseases[:20] %}
        <tr>
          <td>{{ disease.get("disease_name", "—") }}</td>
          <td>
            {% if disease.get("overall_score") is not none %}
              {{ "%.3f" | format(disease.get("overall_score", 0)) }}
              <div class="score-bar" style="width:{{ (disease.get('overall_score', 0) * 150) | int }}px"></div>
            {% else %}—{% endif %}
          </td>
          <td>{{ disease.get("data_types", "—") }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% if not drugs and not diseases and not target %}
    <p>No drug target data found for this gene.</p>
  {% endif %}

  {% if drug_targets.get("errors") %}
    <div class="error-list">Errors: {{ drug_targets["errors"] | join(", ") }}</div>
  {% endif %}
{% endif %}
</div>
</details>

<!-- 8. COMPETITIVE INTELLIGENCE -->
<details class="section" id="competitive-intel">
<summary>Competitive Intelligence</summary>
<div class="section-content">
{% set companies = competitive_intel.get("companies", {}) %}
{% if companies %}
  <p>Companies with patents and/or clinical trials targeting <strong>{{ gene_symbol }}</strong>:</p>
  {% for company, data in companies.items() %}
    <div class="company-card">
      <h4>{{ company }}</h4>
      {% if data.get("patents") %}
        <p><strong>Patents:</strong> <span class="count-badge">{{ data["patents"] | length }}</span></p>
        <ul>
        {% for p in data["patents"][:5] %}
          <li>{{ p.get("title", "Untitled") }} ({{ p.get("date", "n/d") }}) — <a href="https://patents.google.com/patent/US{{ p.get('patent_number', '') }}" target="_blank" rel="noopener">{{ p.get("patent_number", "") }}</a></li>
        {% endfor %}
        {% if data["patents"] | length > 5 %}<li><em>... and {{ data["patents"] | length - 5 }} more</em></li>{% endif %}
        </ul>
      {% endif %}
      {% if data.get("trials") %}
        <p><strong>Clinical Trials:</strong> <span class="count-badge">{{ data["trials"] | length }}</span></p>
        <ul>
        {% for t in data["trials"][:5] %}
          <li>{{ t.get("title", "Untitled") }} — Phase {{ t.get("phase", "?") }} ({{ t.get("status", "unknown") }})
            {% if t.get("nct_id") %} <a href="https://clinicaltrials.gov/study/{{ t['nct_id'] }}" target="_blank">{{ t["nct_id"] }}</a>{% endif %}
          </li>
        {% endfor %}
        {% if data["trials"] | length > 5 %}<li><em>... and {{ data["trials"] | length - 5 }} more</em></li>{% endif %}
        </ul>
      {% endif %}
    </div>
  {% endfor %}
{% else %}
  <p>No competitive intelligence data available. This may indicate no patents or clinical trials were found, or those search phases were unavailable.</p>
{% endif %}
</div>
</details>

<!-- 9. REFERENCES -->
<details class="section" id="references">
<summary>References <span class="count-badge">{{ references | length }}</span></summary>
<div class="section-content">
{% if references %}
  <table>
    <thead><tr><th>#</th><th>Source</th><th>Title</th><th>Authors</th><th>Year</th><th>Link</th></tr></thead>
    <tbody>
    {% for ref in references %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ ref.get("source", "—") }}</td>
        <td>{{ ref.get("title", "—") if ref.get("title") else "—" }}</td>
        <td>{{ ref.get("authors", "—") if ref.get("authors") else "—" }}</td>
        <td>{{ ref.get("year", "—") if ref.get("year") else "—" }}</td>
        <td>{% if ref.get("url") %}<a href="{{ ref['url'] }}" target="_blank">{{ ref.get("id", "Link") or "Link" }}</a>{% else %}—{% endif %}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>No references collected.</p>
{% endif %}
</div>
</details>

</div>

<script>
// Sortable tables
document.querySelectorAll('th').forEach(th => {
  th.addEventListener('click', function() {
    const table = this.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const idx = Array.from(this.parentNode.children).indexOf(this);
    const asc = this.dataset.sort !== 'asc';
    this.parentNode.querySelectorAll('th').forEach(h => delete h.dataset.sort);
    this.dataset.sort = asc ? 'asc' : 'desc';
    rows.sort((a, b) => {
      const at = (a.children[idx] || {}).textContent || '';
      const bt = (b.children[idx] || {}).textContent || '';
      const an = parseFloat(at), bn = parseFloat(bt);
      if (!isNaN(an) && !isNaN(bn)) return asc ? an - bn : bn - an;
      return asc ? at.localeCompare(bt) : bt.localeCompare(at);
    });
    rows.forEach(r => tbody.appendChild(r));
  });
});
</script>
</body>
</html>
